<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tourpass AI ì–´ì‹œìŠ¤í„´íŠ¸</title>

  <!-- Pretendard -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --bg:#ffffff;
      --panel:#f8fafc;
      --brand:#5b46ff;
      --ok:#10b981;
      --shadow:0 10px 40px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Pretendard',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #eef2ff 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 110%, #fdf2f8 0%, transparent 60%),
        #fff;
      display:flex; align-items:center; justify-content:center;
      padding:24px;
    }

    /* ====== ì¹´ë“œ ====== */
    .app{
      width:min(920px, 96vw);
      background:#fff;
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .header{
      padding:22px 24px;
      border-bottom:1px solid var(--line);
      text-align:center;
      background:linear-gradient(180deg, #ffffff, #fbfbff);
    }
    .brand{ font-weight:800; font-size:clamp(22px, 3.6vw, 28px); }
    .sub{ color:var(--muted); font-size:14px; margin-top:6px }

    .main{ padding:26px 24px; }
    .title{
      font-weight:800;
      font-size:clamp(22px, 3.6vw, 30px);
      text-align:center;
      margin:0 0 22px;
    }

    /* ====== ì…ë ¥ ë°” ====== */
    .askbar{
      position:relative;
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 18px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow);
      transition:all .2s ease;
    }
    .askbar:focus-within{
      outline:2px solid color-mix(in oklab, var(--brand) 35%, white);
      outline-offset:2px;
    }
    .input{
      flex:1;
      border:none; outline:none;
      font-size:16px; color:var(--ink);
      background:transparent;
    }
    .input::placeholder{ color:var(--muted); }

    .btn{
      width:38px; height:38px;
      border:none; background:#fff;
      border-radius:50%;
      display:grid; place-items:center;
      cursor:pointer; border:1px solid var(--line);
      transition:all .15s ease;
    }
    .btn:hover{ background:#f9f9ff }
    .btn:active{ transform:translateY(1px) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn[data-on="true"]{
      border-color:color-mix(in oklab, var(--ok) 60%, var(--line));
      box-shadow:0 0 0 4px color-mix(in oklab, var(--ok) 18%, white);
    }

    .hint{ margin-top:12px; text-align:center; font-size:13px; color:var(--muted); }

    /* ====== ê²°ê³¼ ====== */
    .result{
      margin-top:22px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:14px;
      padding:18px;
      display:none;
    }
    .res-head{ display:flex; align-items:center; gap:8px; font-weight:700; margin-bottom:10px; }
    .loader{ width:16px; height:16px; border-radius:50%; border:2px solid var(--brand); border-top-color:transparent; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .answer{
      background:#fff; border:1px solid var(--line); border-radius:12px;
      padding:16px; line-height:1.7; font-size:15px;
    }
    .recs{ margin-top:12px; background:#fff; border:1px dashed var(--line); border-radius:10px; padding:12px }
    .recs h4{ margin:0 0 8px; font-size:14px }
    .recs ol{ margin:0; padding-left:18px }

    /* ì˜µì…˜ ë°”(ë””ë²„ê·¸, ë¼ìŠ¤íŠ¸ID ì €ì¥) */
    .opts{
      margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:var(--muted); font-size:13px
    }
    .opts input[type="text"]{
      height:34px; border:1px solid var(--line); border-radius:10px; padding:0 10px; outline:none;
    }
    .opts label{ display:flex; gap:6px; align-items:center; }

    @media (max-width:520px){
      .main{ padding:18px }
      .askbar{ padding:12px 14px }
      .opts{ flex-direction:column; align-items:flex-start }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- í—¤ë” -->
    <header class="header">
      <div class="brand">Tourpass AI ì–´ì‹œìŠ¤í„´íŠ¸</div>
      <div class="sub">Google Sheets + OpenAIë¡œ ë§Œë“œëŠ” ì§€ëŠ¥í˜• ë¹„ì„œ</div>
    </header>

    <!-- ë©”ì¸ -->
    <main class="main">
      <h1 class="title">íˆ¬ì–´íŒ¨ìŠ¤ ì›Œí¬ìˆì— ëŒ€í•´ ê¶ê¸ˆí•˜ì„¸ìš”?</h1>

      <!-- ì…ë ¥ ë°” -->
      <div class="askbar" role="search" aria-label="ì§ˆë¬¸ ì…ë ¥ì°½">
        <input id="q" class="input" placeholder="ì˜ˆ) 2ì¼ì°¨ ì„¸ë¶€ ì¼ì • ë³´ì—¬ì¤˜" autocomplete="off" />
        <button id="mic" class="btn" title="ìŒì„± ì…ë ¥" aria-label="ìŒì„± ì…ë ¥">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3Z" stroke="currentColor" stroke-width="1.5"/>
            <path d="M19 11a7 7 0 0 1-14 0" stroke="currentColor" stroke-width="1.5"/>
            <path d="M12 18v3" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </button>
        <button id="send" class="btn" title="ì§ˆë¬¸ ë³´ë‚´ê¸° (Enter)" aria-label="ì§ˆë¬¸ ë³´ë‚´ê¸°">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
            <path d="M4 12l16-8-7 8 7 8-16-8z" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
        </button>
      </div>
      <p class="hint">Enter ì „ì†¡ Â· ë§ˆì´í¬ë¡œ ë§í•˜ê¸° Â· ë°±ì—”ë“œëŠ” Google Apps Script ì›¹ì•±</p>

      <!-- ì˜µì…˜ -->
      <div class="opts">
        <label><input type="checkbox" id="dbg"> ë””ë²„ê·¸ ë©”íƒ€ ì¶œë ¥(ì½˜ì†”)</label>
        <label>ìµœê·¼ ê°€ë§¹ì ID
          <input type="text" id="lastId" placeholder="ì˜ˆ: P1234 (ì„ íƒ)" />
        </label>
        <button id="saveId" class="btn" title="ìµœê·¼ID ì €ì¥" aria-label="ìµœê·¼ID ì €ì¥">ğŸ’¾</button>
        <span id="savedNote" aria-live="polite"></span>
      </div>

      <!-- ê²°ê³¼ -->
      <section id="result" class="result" aria-live="polite" aria-busy="false">
        <div class="res-head">
          <div id="busy" class="loader" hidden></div>
          <div>GPT ë¶„ì„ ê²°ê³¼</div>
        </div>
        <div id="answer" class="answer"></div>
        <div id="recs" class="recs" style="display:none">
          <h4>ë‹¤ìŒ ê°€ë§¹ì  ì¶”ì²œ (Top3)</h4>
          <ol id="recList"></ol>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* =================== ì„¤ì • =================== */
    // 1) ë³¸ì¸ GAS ì›¹ì•± URLë¡œ êµì²´
    const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxM8pNBBnAxRyoIYHO8be82IzlTCPYOcRRjq_aoiTvcyoprVNhfXQx_KsZlVSVGJlhn/exec';
    // 2) ë°±ì—”ë“œì—ì„œ BACKEND_TOKENì„ ì“°ëŠ” ê²½ìš°ë§Œ ì…ë ¥
    const BACKEND_TOKEN = ''; // ì˜ˆ: 'my-secret-token'

    /* ============== ì—˜ë¦¬ë¨¼íŠ¸ ============== */
    const $q       = document.getElementById('q');
    const $result  = document.getElementById('result');
    const $answer  = document.getElementById('answer');
    const $busy    = document.getElementById('busy');
    const $send    = document.getElementById('send');
    const $mic     = document.getElementById('mic');
    const $dbg     = document.getElementById('dbg');
    const $lastId  = document.getElementById('lastId');
    const $saveId  = document.getElementById('saveId');
    const $recs    = document.getElementById('recs');
    const $recList = document.getElementById('recList');
    const $savedNote = document.getElementById('savedNote');

    // ì´ˆê¸°: localStorageì—ì„œ last_place_id ë¶ˆëŸ¬ì˜¤ê¸°
    $lastId.value = localStorage.getItem('tourpass:last_place_id') || '';

    /* ============== ì „ì†¡ ============== */
    async function ask() {
      const text = $q.value.trim();
      if (!text) { alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

      toggleBusy(true);
      try {
        const reqBody = {
          query: text,
          last_place_id: $lastId.value.trim() || undefined,
          token: BACKEND_TOKEN || undefined,
          debug: $dbg.checked || undefined
        };

        const res = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reqBody)
        });

        if (!res.ok) throw new Error('ì‘ë‹µ ì˜¤ë¥˜: ' + res.status);
        const data = await res.json();

        // ë””ë²„ê·¸ ë©”íƒ€ ì½˜ì†” ì¶œë ¥
        if ($dbg.checked && data.meta) {
          console.log('[BACKEND META]', data.meta);
        }
        console.log('[BACKEND SOURCE]', data.source || '(ë¯¸í‘œê¸°)');

        // ê²°ê³¼ ë Œë”
        $result.style.display = 'block';
        if (data.error) {
          $answer.innerHTML = `<span style="color:#ef4444">${escapeHtml(data.error)}</span>`;
        } else {
          const text = (data.answer || '(í™•ì¸ í•„ìš”) ì‘ë‹µ ì—†ìŒ');
          $answer.innerHTML = escapeHtml(text).replace(/\n/g,'<br/>');
        }

        // ì¶”ì²œ í‘œì‹œ
        if (Array.isArray(data.recs) && data.recs.length) {
          $recs.style.display = 'block';
          $recList.innerHTML = data.recs.map(r =>
            `<li>${escapeHtml(r.name)} <small>[${escapeHtml(r.place_id)}] Â· ì ìˆ˜:${escapeHtml(String(r.score))}</small></li>`
          ).join('');
        } else {
          $recs.style.display = 'none';
          $recList.innerHTML = '';
        }

      } catch (e) {
        console.error(e);
        $result.style.display = 'block';
        $answer.innerHTML = '<span style="color:#ef4444">ì˜¤ë¥˜ ë°œìƒ: ì›¹ì•± URL/ê¶Œí•œ/ìŠ¤í¬ë¦½íŠ¸ ì†ì„±(OPENAI_API_KEY)ì„ í™•ì¸í•˜ì„¸ìš”.</span>';
        $recs.style.display = 'none';
        $recList.innerHTML = '';
      } finally {
        toggleBusy(false);
      }
    }

    function toggleBusy(b) {
      $busy.hidden = !b;
      $result.setAttribute('aria-busy', b ? 'true' : 'false');
      $send.disabled = b;
      $q.disabled    = b;
      $mic.disabled  = b;
    }

    /* ============== ì´ë²¤íŠ¸ ============== */
    $send.addEventListener('click', ask);
    $q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ ask(); }});

    $saveId.addEventListener('click', ()=>{
      const v = $lastId.value.trim();
      if (v) {
        localStorage.setItem('tourpass:last_place_id', v);
        $savedNote.textContent = 'ì €ì¥ë¨';
      } else {
        localStorage.removeItem('tourpass:last_place_id');
        $savedNote.textContent = 'ì‚­ì œë¨';
      }
      setTimeout(()=> $savedNote.textContent='', 1200);
    });

    /* ============== ìŒì„± ì…ë ¥(Web Speech API) ============== */
    let rec;
    if ('webkitSpeechRecognition' in window) {
      rec = new webkitSpeechRecognition();
      rec.lang = 'ko-KR';
      rec.interimResults = false; rec.maxAlternatives = 1;
      rec.onresult = (ev)=>{ const t = ev.results[0][0].transcript; $q.value = t; ask(); };
      rec.onerror = ()=> toggleMic(false);
    }
    function toggleMic(forceOff){
      if (!rec) { alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•Šì•„ìš”.'); return; }
      const on = $mic.dataset.on === 'true';
      const next = forceOff ? false : !on;
      $mic.dataset.on = String(next);
      if (next) rec.start(); else rec.stop();
    }
    $mic.addEventListener('click', ()=> toggleMic());

    /* ============== ìœ í‹¸ ============== */
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[s]);
    }
  </script>
</body>
</html>
