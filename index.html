<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LS TourPass AI Search</title>
<meta name="backend-url" content="https://script.google.com/macros/s/AKfycbxM8pNBBnAxRyoIYHO8be82IzlTCPYOcRRjq_aoiTvcyoprVNhfXQx_KsZlVSVGJlhn/exec">
<meta name="backend-token" content="settings의 BACKEND_TOKEN">
<style>
  :root{
    --ink:#0f172a;--muted:#64748b;--line:#e2e8f0;
    --brand:#1e40af;--bg:#ffffff;--panel:#f8fafc;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{max-width:760px;width:100%;text-align:center}
  .logo{font-weight:800;font-size:28px;color:var(--brand);letter-spacing:0.3px;margin-bottom:24px}
  .search{display:flex;gap:8px;align-items:center;justify-content:center}
  input[type="text"]{flex:1;max-width:640px;padding:16px 18px;border:1px solid var(--line);border-radius:999px;font-size:16px;background:#fff}
  button{padding:14px 18px;border:none;border-radius:999px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
  .meta{margin-top:16px;color:var(--muted);font-size:13px}
  .result{margin-top:28px;text-align:left;border:1px solid var(--line);border-radius:16px;background:#fff;padding:18px}
  .answer{white-space:pre-wrap;line-height:1.55}
  .badge{display:inline-block;font-size:12px;color:#334155;background:#eef2ff;border:1px solid #e0e7ff;padding:4px 8px;border-radius:999px;margin-right:6px}
  .skeleton{height:14px;background:#e5e7eb;border-radius:6px;animation:pulse 1.2s infinite}
  @keyframes pulse{0%{opacity:.6}50%{opacity:.25}100%{opacity:.6}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="logo">LS TourPass • AI Search</div>
    <div class="search">
      <input id="q" type="text" placeholder="무엇이든 물어보세요 (예: 충남투어패스 운영지표 요약)" autofocus />
      <button id="go">질문하기</button>
    </div>
    <div class="meta">프롬프트/모델/비용 정책은 운영 시트에서 제어됩니다.</div>
    <div id="result" class="result" style="display:none">
      <div id="badges"></div>
      <div id="answer" class="answer"></div>
      <div id="trace" class="meta" style="margin-top:8px"></div>
    </div>
  </div>
</div>
<script>
  const $q = document.getElementById('q');
  const $go = document.getElementById('go');
  const $res = document.getElementById('result');
  const $ans = document.getElementById('answer');
  const $badges = document.getElementById('badges');
  const $trace = document.getElementById('trace');

  const BACKEND_URL = document.querySelector('meta[name="backend-url"]').content;
  const BACKEND_TOKEN = document.querySelector('meta[name="backend-token"]').content;
  const sessionId = localStorage.getItem('tp_session') || (()=>{ const v=crypto.randomUUID(); localStorage.setItem('tp_session',v); return v; })();

  function skeleton() {
    $res.style.display = 'block';
    $badges.innerHTML = `<span class="badge">생성 중…</span>`;
    $ans.innerHTML = `
      <div class="skeleton" style="width:92%;margin:8px 0;"></div>
      <div class="skeleton" style="width:88%;margin:8px 0;"></div>
      <div class="skeleton" style="width:94%;margin:8px 0;"></div>
      <div class="skeleton" style="width:70%;margin:8px 0;"></div>`;
    $trace.textContent = '';
  }

  async function ask() {
    const question = $q.value.trim();
    if (!question) return;
    skeleton();
    try {
      const r = await fetch(BACKEND_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json','X-Backend-Token': BACKEND_TOKEN},
        body: JSON.stringify({question, sessionId})
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error||'server error');
      $badges.innerHTML = `
        <span class="badge">모델: ${j.model||'?'}</span>
        <span class="badge">지연: ${j.latency_ms??'?'}ms</span>
        <span class="badge">토큰: ${j.usage_tokens??'?'}</span>
        <span class="badge">Row #${j.rowId||'?'}</span>`;
      $ans.textContent = j.answer || '(응답 없음)';
      $trace.textContent = '※ 이 응답은 Google 스프레드시트에 기록되었습니다.';
      // 로컬 히스토리
      const h = JSON.parse(localStorage.getItem('tp_hist')||'[]');
      h.unshift({t:Date.now(), q:question, a:j.answer});
      localStorage.setItem('tp_hist', JSON.stringify(h.slice(0,20)));
    } catch (e) {
      $badges.innerHTML = `<span class="badge" style="background:#fee2e2;border-color:#fecaca;color:#991b1b">오류</span>`;
      $ans.textContent = `요청 실패: ${e.message}`;
      $trace.textContent = '다시 시도하거나, 운영자에게 문의해주세요.';
    }
  }
  $go.addEventListener('click', ask);
  $q.addEventListener('keydown', e => { if (e.key==='Enter') ask(); });
</script>
</body>
</html>
